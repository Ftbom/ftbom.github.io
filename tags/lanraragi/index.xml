<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>LANraragi - 标签 - Ftbom&#39;s Blog</title>
        <link>https://ftbom.github.io/tags/lanraragi/</link>
        <description>LANraragi - 标签 - Ftbom&#39;s Blog</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>lz490070@gmail.com (Ftbom)</managingEditor>
            <webMaster>lz490070@gmail.com (Ftbom)</webMaster><lastBuildDate>Tue, 03 Jan 2023 16:20:52 &#43;0800</lastBuildDate><atom:link href="https://ftbom.github.io/tags/lanraragi/" rel="self" type="application/rss+xml" /><item>
    <title>LANraragi插件小记</title>
    <link>https://ftbom.github.io/lanraragi_plugins/</link>
    <pubDate>Tue, 03 Jan 2023 16:20:52 &#43;0800</pubDate><author>
        <name>Ftbom</name>
    </author><guid>https://ftbom.github.io/lanraragi_plugins/</guid>
    <description><![CDATA[<p style="text-align: center;">
    
</p>
<p>LANraragi提供了丰富的插件和脚本，借助插件能够以多种途径获取漫画的信息，但是这些插件并没有完全满足我的需求。</p>
<p>于是有了这篇文章，记录我的LANraragi插件编写过程。</p>
<h2 id="需求" class="headerLink">
    <a href="#%e9%9c%80%e6%b1%82" class="header-mark"></a>需求</h2><p>在LANraragi中，漫画的信息被记录成<code>tags</code>和<code>categories</code>，即标签和种类。</p>
<p>我的需求是能从文件的目录结构提取出漫画的标签和种类，文件的结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">category1
</span></span><span class="line"><span class="cl">  --tag1
</span></span><span class="line"><span class="cl">      --mangafile1
</span></span><span class="line"><span class="cl">      --mangafile2
</span></span><span class="line"><span class="cl">  --tag2
</span></span><span class="line"><span class="cl">      --mangafile3
</span></span><span class="line"><span class="cl">category2
</span></span><span class="line"><span class="cl">  --tag3
</span></span><span class="line"><span class="cl">      --mangafile4
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="折腾结果" class="headerLink">
    <a href="#%e6%8a%98%e8%85%be%e7%bb%93%e6%9e%9c" class="header-mark"></a>折腾结果</h2><p>LANraragi中并不存在实现上述功能的插件，于是我就参照已有的插件，实现了这些功能。</p>
<p>最终完成了一个脚本和一个插件：</p>
<ul>
<li>TagFolder.pm(插件)</li>
</ul>
<blockquote>
<p>将文件所属的文件夹名作为漫画的tag</p>
</blockquote>
<ul>
<li>TopfolderCat.pm(脚本)</li>
</ul>
<blockquote>
<p>将文件所属的顶层文件夹名作为漫画的category</p>
</blockquote>
<h3 id="tagfolderpm" class="headerLink">
    <a href="#tagfolderpm" class="header-mark"></a>TagFolder.pm</h3><blockquote>
<p>参照Filename Parsing v.1.0 by Difegue</p>
</blockquote>
<p style="text-align: center;">
    
</p>
<p>使用说明：</p>
<ul>
<li>Plugin Settings设置tag的类别，如图中所示则最终tag效果为<code>artist: tagname</code></li>
<li>开启Run Automatically则自动对新添加的漫画运行插件</li>
</ul>
<p>文件内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">LANraragi::Plugin::Metadata::TagFolder</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Plugins can freely use all Perl packages already installed on the system</span>
</span></span><span class="line"><span class="cl"><span class="c1">#Try however to restrain yourself to the ones already installed for LRR (see tools/cpanfile) to avoid extra installations by the end-user.</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">File::Basename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#You can also use the LRR Internal API when fitting.</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Model::Plugins</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Database</span> <span class="sx">qw(redis_encode redis_decode)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Logging</span> <span class="sx">qw(get_logger)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Meta-information about your plugin.</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">plugin_info</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#Standard metadata</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>      <span class="o">=&gt;</span> <span class="s">&#34;Use foldername as tag&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">type</span>      <span class="o">=&gt;</span> <span class="s">&#34;metadata&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">namespace</span> <span class="o">=&gt;</span> <span class="s">&#34;tagfolder&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">author</span>    <span class="o">=&gt;</span> <span class="s">&#34;Ftbom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span>   <span class="o">=&gt;</span> <span class="s">&#34;1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;Generate the tag from the folder&#39;s name.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">icon</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAL1JREFUOI1jZMABpNbH/sclx8DAwPAscDEjNnEMQUIGETIYhUOqYdgMhTPINQzdUEZqGIZsKBM1DEIGTOiuexqwCKdidDl0vtT62P9kuZCJEWuKYWBgYGBgRHbh04BFDNIb4jAUbbSrZTARUkURg6lD10OUC/0PNaMYgs1Skgwk1jCSDCQWoBg46dYmhite0+D8pwGLCMY6uotRDOy8toZBkI2HIhcO/pxCm8KBUkOxFl/kGoq3gCXFYFxVAACeoU/8xSNybwAAAABJRU5ErkJggg==&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">parameters</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=&gt;</span> <span class="s">&#34;The category of tag&#34;</span> <span class="p">}</span> <span class="p">]</span> <span class="c1">#plugin设置</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Mandatory function to be implemented by your plugin</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">get_tags</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">shift</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$lrr_info</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>    <span class="c1"># Global info hash</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="p">(</span><span class="nv">$category</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>    <span class="c1"># Plugin parameters</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span> <span class="s">&#34;tagfolder&#34;</span><span class="p">,</span> <span class="s">&#34;plugins&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$file</span>   <span class="o">=</span> <span class="nv">$lrr_info</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">file_path</span><span class="p">};</span> <span class="c1">#完整文件地址</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$tagstring</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># lrr_info&#39;s file_path is taken straight from the filesystem, which might not be proper UTF-8.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Run a decode to make sure we can derive tags with the proper encoding.</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file</span> <span class="o">=</span> <span class="n">redis_decode</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get the filename from the file_path info field</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="p">(</span> <span class="nv">$filename</span><span class="p">,</span> <span class="nv">$filepath</span><span class="p">,</span> <span class="nv">$suffix</span> <span class="p">)</span> <span class="o">=</span> <span class="n">fileparse</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="sx">qr/\.[^.]*/</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$_</span> <span class="o">=</span> <span class="s">&#34;$filepath&#34;</span><span class="p">;</span> <span class="c1">#获取文件地址</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="sr">/\/([^\/]+)\/$/</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$tagstring</span><span class="o">=</span><span class="s">&#34;$category:$1&#34;</span><span class="p">;</span> <span class="c1">#上级目录作tag名</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#34;Sending the following tags to LRR: &#34;</span> <span class="o">.</span> <span class="nv">$tagstring</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span> <span class="n">tags</span> <span class="o">=&gt;</span> <span class="nv">$tagstring</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="topfoldercatpm" class="headerLink">
    <a href="#topfoldercatpm" class="header-mark"></a>TopfolderCat.pm</h3><blockquote>
<p>参照Subfolders to Categories v.1.0 by Difegue</p>
</blockquote>
<p style="text-align: center;">
    
</p>
<p>使用说明：</p>
<ul>
<li>点击Trigger Script运行脚本</li>
<li>Plugin Settings设置是否先删除已有的类型</li>
</ul>
<p>文件内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">LANraragi::Plugin::Scripts::TopfolderCat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">File::Find</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">File::Basename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">Data::Dumper</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Logging</span> <span class="sx">qw(get_logger)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Generic</span> <span class="sx">qw(is_archive)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Database</span> <span class="sx">qw(compute_id)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Model::Category</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">our</span> <span class="nv">$fatherdirname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Meta-information about your plugin.</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">plugin_info</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#Standard metadata</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>      <span class="o">=&gt;</span> <span class="s">&#34;Top Subfolders to Categories&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">type</span>      <span class="o">=&gt;</span> <span class="s">&#34;script&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">namespace</span> <span class="o">=&gt;</span> <span class="s">&#34;Tfldr2cat&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">author</span>    <span class="o">=&gt;</span> <span class="s">&#34;Ftbom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span>   <span class="o">=&gt;</span> <span class="s">&#34;1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">icon</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAuJJREFUOI3FlE1sVFUUx3/nvVdaSqd0sAmElDYopOWjsKiEnYkLowU2uMGw0ajBhS5oqAtwo3FTaIQNCz7CBldEE01M+AglJMACUyBQrI6iQ2groNNxpjPz5n3MnXddvOnrfACNK09yk/fuved3//933j3wf8Thw6O6q6tHd3X16FOnTusX7ZW7I7H0kuUrV6hCtmHxt7UnOXHiDInEJAAzM49kscMtw2xesWHfKOTGASNa+GnmHfYP7gSgr28TY2PnF4UBWAD88Tlk7kFVyuDbX0ew43vzU/6bnc+12vnqx4OrX//i4gIQXS2uJkZGvqRXD3Q/V9LKXdjmSxcmjq7ahi6vtRazMKAHGua8oolbsHDyFk7iF4r/3IOyGl9QKI1u+vo2kUhMsmZ3T8Pa5c+E5vYYzbFWWkQTW23R+XKc+9/+eKUB+MbBHZWqhpW9MGSjtdDes57OzRtZ2hFD4tshcEAVkHIeVIapse8wDPNQxbKBDuDhxHKODd5myZ44698dBTQgUbEkex0CFzJXIfDC58CDwCP3Z1ZtPpAaD4FWnJIv2Nkm+j85AroE/jRoHwI/SgoBbt27h+54DS3je0VEh7VtimOnm2mKxRcguhpUDXvGUDb9bd3fh14rCtNPWuh9/6s6RfWq6mEetG0le/cb5KPbpajKActwChaIVNR5ddAqeLkCmt9TLjCbzEVFtQDstENTW0c4M58cJbiNsPmxtBs7eQ03p87VANP3J+n94CjiPKj76N4z7M4f6IPKk35YAFMORUCzpRU3/VdoV82BytUm+jMQlEArlBJmEyncORdnroTypxCRt7YMp5IRUBVzv/cPnV0n+VshyH8MgYuycyjHJjPt4GbyONki5VIAItfQnBeTG62YD1458DTF8EJXscSw1lEu4s0m8TJ/k/o5iZuZIygHlb+ZHwzkUoC+2T+cuiNSd08/re1qMjFa25YM5D0xjVtGe8fUhg9/zfMf41+ZdKPYI8TqHgAAAABJRU5ErkJggg==&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;Scan your Content Folder and automatically create Static Categories for each top subfolder.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">parameters</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">[</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&#34;bool&#34;</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=&gt;</span> <span class="s">&#34;Delete all your static categories before creating the ones matching your subfolders&#34;</span> <span class="p">}</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Mandatory function to be implemented by your script</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">run_script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">shift</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$lrr_info</span>          <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="p">(</span><span class="nv">$delete_old_cats</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$logger</span>            <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span> <span class="s">&#34;Folder2Category&#34;</span><span class="p">,</span> <span class="s">&#34;plugins&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$userdir</span>           <span class="o">=</span> <span class="nn">LANraragi::Model::Config</span><span class="o">-&gt;</span><span class="n">get_userdir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">%subfolders</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">@created_categories</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$delete_old_cats</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">&#34;Deleting all Static Categories before folder walking as instructed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">@categories</span> <span class="o">=</span> <span class="nn">LANraragi::Model::Category</span><span class="o">-&gt;</span><span class="n">get_category_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">my</span> <span class="nv">$category</span> <span class="p">(</span><span class="nv">@categories</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$category</span><span class="p">}{</span><span class="s">&#34;search&#34;</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#34;&#34;</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">my</span> <span class="nv">$cat_id</span> <span class="o">=</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$category</span><span class="p">}{</span><span class="s">&#34;id&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">(</span><span class="s">&#34;Deleting &#39;$cat_id&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nn">LANraragi::Model::Category::</span><span class="n">delete_category</span><span class="p">(</span><span class="nv">$cat_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Walk through content folder and find all subfolders with files in them</span>
</span></span><span class="line"><span class="cl">    <span class="n">find</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   <span class="n">wanted</span> <span class="o">=&gt;</span> <span class="k">sub</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">if</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span> <span class="ow">eq</span> <span class="nv">$userdir</span><span class="p">;</span>    <span class="c1"># Direct children of the content dir are excluded</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span> <span class="n">is_archive</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">unless</span> <span class="p">(</span> <span class="nb">exists</span><span class="p">(</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>        <span class="c1"># Create array in hash for this folder</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">},</span> <span class="nv">$_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$fatherdirname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">no_chdir</span>    <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">follow_fast</span> <span class="o">=&gt;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$userdir</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#34;Find routine results: &#34;</span> <span class="o">.</span> <span class="n">Dumper</span> <span class="nv">%subfolders</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># For each subfolder with file, create a category bearing its name and containing all its files</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="k">my</span> <span class="nv">$folder</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%subfolders</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$catID</span> <span class="o">=</span> <span class="nn">LANraragi::Model::Category::</span><span class="n">create_category</span><span class="p">(</span> <span class="nv">$folder</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">push</span> <span class="nv">@created_categories</span><span class="p">,</span> <span class="nv">$catID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">my</span> <span class="nv">$file</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$folder</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="n">compute_id</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="o">||</span> <span class="k">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nn">LANraragi::Model::Category::</span><span class="n">add_to_category</span><span class="p">(</span> <span class="nv">$catID</span><span class="p">,</span> <span class="nv">$id</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#顶级目录名作分类名</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span> <span class="n">created_categories</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@created_categories</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="代码浅析" class="headerLink">
    <a href="#%e4%bb%a3%e7%a0%81%e6%b5%85%e6%9e%90" class="header-mark"></a>代码浅析</h2><p>简单分析一下这两个插件的代码，我并没有系统地学习过Perl语言，分析过程可能存在错误。</p>
<p><code>plugin_info</code>函数返回插件的基本信息；TagFolder是元数据插件，主体内容是<code>get_tags</code>函数；TopfolderCat是脚本，主体内容是<code>run_script</code>函数。</p>
<p><code>plugin_info</code>函数的parameters返回值定义了插件的设置项，例如：
TagFolder定义插件的设置项是string类型，获取输入字符；TopfolderCat定义插件的设置项是bool类型，获取开关的状态。</p>
<p>在主体函数中可以通过<code>@_</code>获取插件的设置值。</p>
<h3 id="tagfolderpm分析" class="headerLink">
    <a href="#tagfolderpm%e5%88%86%e6%9e%90" class="header-mark"></a>TagFolder.pm分析</h3><p>TagFolder参照Filename Parsing，对其中关键代码的运行过程进行分析。</p>
<p>首先获取全局信息和插件设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$lrr_info</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="c1">#全局信息</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="p">(</span><span class="nv">$category</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span> <span class="c1">#插件设置</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>全局信息中包括文件路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$file</span>   <span class="o">=</span> <span class="nv">$lrr_info</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">file_path</span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后从文件路径中分离出文件名和文件所在文件夹路径，我们需要的是文件夹路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="p">(</span> <span class="nv">$filename</span><span class="p">,</span> <span class="nv">$filepath</span><span class="p">,</span> <span class="nv">$suffix</span> <span class="p">)</span> <span class="o">=</span> <span class="n">fileparse</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="sx">qr/\.[^.]*/</span> <span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从文件夹路径中获取文件夹名，得到tag字符串：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="nv">$_</span> <span class="o">=</span> <span class="s">&#34;$filepath&#34;</span><span class="p">;</span> <span class="c1">#$_是默认的参数变量</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="sr">/\/([^\/]+)\/$/</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$tagstring</span><span class="o">=</span><span class="s">&#34;$category:$1&#34;</span><span class="p">;</span> <span class="c1">#$1获取正则表达式匹配的第一项</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后输出tag信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">return</span> <span class="p">(</span> <span class="n">tags</span> <span class="o">=&gt;</span> <span class="nv">$tagstring</span> <span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="topfoldercatpm分析" class="headerLink">
    <a href="#topfoldercatpm%e5%88%86%e6%9e%90" class="header-mark"></a>TopfolderCat.pm分析</h3><p>TopfolderCat.pm参照Subfolders to Categories，相较于参考文件改动较小，改动部分为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">return</span> <span class="k">if</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span> <span class="ow">eq</span> <span class="nv">$userdir</span><span class="p">;</span>    <span class="c1"># Direct children of the content dir are excluded</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="n">is_archive</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">unless</span> <span class="p">(</span> <span class="nb">exists</span><span class="p">(</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>        <span class="c1"># Create array in hash for this folder</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">},</span> <span class="nv">$_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$fatherdirname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里假设文件目录结构为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">category1
</span></span><span class="line"><span class="cl">  --tag1
</span></span><span class="line"><span class="cl">      --mangafile1
</span></span><span class="line"><span class="cl">      --mangafile2
</span></span><span class="line"><span class="cl">  --tag2
</span></span><span class="line"><span class="cl">      --mangafile3
</span></span><span class="line"><span class="cl">category2
</span></span><span class="line"><span class="cl">  --tag3
</span></span><span class="line"><span class="cl">      --mangafile4
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先排除漫画目录的直接子文件夹，即categroy1、categroy2等文件夹：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">return</span> <span class="k">if</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span> <span class="ow">eq</span> <span class="nv">$userdir</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于其他的文件和文件夹，如果是文件夹，即tag1、tag2等文件夹，则将其父目录的名称赋值给<code>fatherdirname</code>。即将categroy1、categroy2等赋值给<code>fatherdirname</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$fatherdirname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果是文件，若其路径中存在<code>fatherdirname</code>，则将其添加到对应数组。例如：mangafile1、mangafile2、mangafile3文件被添加到category1对应的数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="n">is_archive</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">unless</span> <span class="p">(</span> <span class="nb">exists</span><span class="p">(</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>        <span class="c1"># Create array in hash for this folder</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">},</span> <span class="nv">$_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后通过这些数组来创建类别，并将对应漫画添加到类别中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">for</span> <span class="k">my</span> <span class="nv">$folder</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%subfolders</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$catID</span> <span class="o">=</span> <span class="nn">LANraragi::Model::Category::</span><span class="n">create_category</span><span class="p">(</span> <span class="nv">$folder</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">push</span> <span class="nv">@created_categories</span><span class="p">,</span> <span class="nv">$catID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">my</span> <span class="nv">$file</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$folder</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="n">compute_id</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="o">||</span> <span class="k">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nn">LANraragi::Model::Category::</span><span class="n">add_to_category</span><span class="p">(</span> <span class="nv">$catID</span><span class="p">,</span> <span class="nv">$id</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description>
</item><item>
    <title>在Termux中安装LANraragi</title>
    <link>https://ftbom.github.io/lanraragi_in_termux/</link>
    <pubDate>Tue, 03 Jan 2023 12:41:00 &#43;0800</pubDate><author>
        <name>Ftbom</name>
    </author><guid>https://ftbom.github.io/lanraragi_in_termux/</guid>
    <description><![CDATA[<p style="text-align: center;">
    
</p>
<p><a href="https://github.com/Difegue/LANraragi" target="_blank" rel="noopener noreferrer">LANraragi</a>是开源的漫画管理服务器，开发者提供了多种安装方式供选择。本文介绍如何在Termux中安装LANraragi，实现对Android手机内的漫画进行管理。</p>
<h2 id="安装termux及ubuntu发行版" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85termux%e5%8f%8aubuntu%e5%8f%91%e8%a1%8c%e7%89%88" class="header-mark"></a>安装Termux及Ubuntu发行版</h2><p><a href="https://termux.dev" target="_blank" rel="noopener noreferrer">Termux</a>是Android系统上的一个高级终端模拟器，可以运行很多Linux系统的软件，还可通过proot安装各种Linux系统发行版。推荐通过Github安装Termux软件。</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">第一次打开Termux若初始化失败，请使用代理</div>
        </div>
    </div>
<p>安装完成后，首先使Termux获取储存权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">termux-setup-storage
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装proot-distro：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pkg install proot-distro
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后安装Ubuntu</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">proot-distro install ubuntu
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装完成后，通过如下命令可进入Ubuntu</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proot-distro login ubuntu
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装lanraragi" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85lanraragi" class="header-mark"></a>安装LANraragi</h2><p>采用源码安装的方式安装LANraragi。</p>
<p>首先，进入Ubuntu并更新软件源：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proot-distro login ubuntu
</span></span><span class="line"><span class="cl">apt update
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先安装LANraragi所需的依赖项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install git curl build-essential make gnupg pkg-config cpanminus redis-server libarchive-dev imagemagick webp libssl-dev zlib1g-dev perlmagick ghostscript
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后安装npm和nodejs：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -sL install-node.vercel.app/lts <span class="p">|</span> bash
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装redis：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install redis
</span></span></code></pre></td></tr></table>
</div>
</div><p>克隆Git仓库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone -b master http://github.com/Difegue/LANraragi /home/koyomi/lanraragi
</span></span></code></pre></td></tr></table>
</div>
</div><p>打开目录并进行编译安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /home/koyomi/lanraragi <span class="o">&amp;&amp;</span> npm run lanraragi-installer install-full
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译需要30-60分钟。</p>
<p>若需要对LANraragi进行更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone -b master http://github.com/Difegue/LANraragi lanraragi
</span></span><span class="line"><span class="cl">cp -fr lanraragi /home/koyomi/
</span></span><span class="line"><span class="cl">npm run lanraragi-installer install-full
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="运行lanraragi" class="headerLink">
    <a href="#%e8%bf%90%e8%a1%8clanraragi" class="header-mark"></a>运行LANraragi</h2><p>通过以下命令运行LANraragi：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">redis-server /etc/redis/redis.conf
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/koyomi/lanraragi <span class="o">&amp;&amp;</span> npm start
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="设置档案位置" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%ae%e6%a1%a3%e6%a1%88%e4%bd%8d%e7%bd%ae" class="header-mark"></a>设置档案位置</h2><p>若已通过以下命令使Termux获取储存权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">termux-setup-storage
</span></span></code></pre></td></tr></table>
</div>
</div><p>则在Ubuntu的<code>/sdcard</code>目录下可以看到Android系统的文件，在LANraragi的设置中设置成对应的漫画目录即可。</p>
]]></description>
</item></channel>
</rss>
