<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>技术笔记 - 分类 - Ftbom&#39;s Blog</title>
        <link>https://ftbom.github.io/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/</link>
        <description>技术笔记 - 分类 - Ftbom&#39;s Blog</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>lz490070@gmail.com (Ftbom)</managingEditor>
            <webMaster>lz490070@gmail.com (Ftbom)</webMaster><lastBuildDate>Thu, 05 Jan 2023 18:02:08 &#43;0800</lastBuildDate><atom:link href="https://ftbom.github.io/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" rel="self" type="application/rss+xml" /><item>
    <title>借助Zapier将Disqus通知推送到Telegram机器人</title>
    <link>https://ftbom.github.io/get_disqus_notifications_by_telegram_bot/</link>
    <pubDate>Thu, 05 Jan 2023 18:02:08 &#43;0800</pubDate><author>
        <name>Ftbom</name>
    </author><guid>https://ftbom.github.io/get_disqus_notifications_by_telegram_bot/</guid>
    <description><![CDATA[<div style="text-align: center;">
    
</div>
<p>之前博客的评论系统用的是<a href="https://valine.js.org/" target="_blank" rel="noopener noreferrer">Valine</a>，最近发现不能用了，原来是LeanCloud限制长时间不使用自动冻结应用。为了省事，把博客的评论系统切换到了<a href="https://disqus.com/" target="_blank" rel="noopener noreferrer">Disqus</a>。</p>
<p>Disqus提供了新评论通知的功能，但是只支持邮件通知、网页通知和Rss订阅三种方式。我并不想每次有新评论都收到邮件，Rss订阅又只支持订阅单个话题，于是就想找到通过Telegram收到新评论通知的方法。</p>
<p>最终通过<a href="https://zapier.com" target="_blank" rel="noopener noreferrer">Zapier</a>实现了通过Telegram收到Disqus新评论通知的功能。</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Zapier免费版每个月只支持运行100次任务，即免费版每个月最多只能收到100条通知</div>
        </div>
    </div>
<h2 id="准备工作" class="headerLink">
    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" class="header-mark"></a>准备工作</h2><ul>
<li>在Telegram上向<a href="https://t.me/BotFather" target="_blank" rel="noopener noreferrer">@BotFather</a>申请机器人token；</li>
<li>在Telegram上通过<a href="https://t.me/userinfobot" target="_blank" rel="noopener noreferrer">@userinfobot</a>获取用户id；</li>
<li>注册Zapier账号。</li>
</ul>
<blockquote>
<p>Zapier上的Disqus连接器如果设置成同时获取多种类型的新评论，在运行时会报错。需要添加两个Zap分别处理已审批和待审批的新评论。</p>
</blockquote>
<h2 id="待审批的新评论" class="headerLink">
    <a href="#%e5%be%85%e5%ae%a1%e6%89%b9%e7%9a%84%e6%96%b0%e8%af%84%e8%ae%ba" class="header-mark"></a>待审批的新评论</h2><h3 id="设置触发器" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%ae%e8%a7%a6%e5%8f%91%e5%99%a8" class="header-mark"></a>设置触发器</h3><p>首先创建新的Zap，Trigger中的App event选择Disqus连接器，然后Event选择为New Comment。如图所示：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/disqus_telegram1.png" title="disqus_telegram1.png" data-thumbnail="/blog_images/disqus_telegram1.png">
        
    </a>
</div>
<p>点击Continue，授权Disqus账户，授权后如图所示：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/disqus_telegram2.png" title="disqus_telegram2.png" data-thumbnail="/blog_images/disqus_telegram2.png">
        
    </a>
</div>
<p>继续设置trigger，include选择Unapproved Posts，Forum选择要获取新评论通知的网站，如图所示：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/disqus_telegram3.png" title="disqus_telegram3.png" data-thumbnail="/blog_images/disqus_telegram3.png">
        
    </a>
</div>
<p>继续向下，测试trigger，获取网站上的待审批评论的数据。若网站尚未有评论，先自行在网站上发一条评论。</p>
<blockquote>
<p>匿名评论一般是待审批评论</p>
</blockquote>
<h3 id="设置响应动作" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%ae%e5%93%8d%e5%ba%94%e5%8a%a8%e4%bd%9c" class="header-mark"></a>设置响应动作</h3><p>设置Zap的Action，App event选择Code by Zapier，Event选择Run Javascript，如图所示：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/disqus_telegram4.png" title="disqus_telegram4.png" data-thumbnail="/blog_images/disqus_telegram4.png">
        
    </a>
</div>
<p>Set up action中Input Data设置如下图：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/disqus_telegram5.png" title="disqus_telegram5.png" data-thumbnail="/blog_images/disqus_telegram5.png">
        
    </a>
</div>
<p><code>tg_token</code>和<code>tg_chatid</code>分别填入准备工作中获取的token和id。</p>
<p>在Set up action的Code中填入以下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">//Telegram机器人token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">TG_API_TOKEN</span> <span class="o">=</span> <span class="nx">inputData</span><span class="p">.</span><span class="nx">tg_token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//chatid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">CHAT_ID</span> <span class="o">=</span> <span class="nx">inputData</span><span class="p">.</span><span class="nx">tg_chatid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">postData</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="sb">`&lt;b&gt;待审批消息&lt;/b&gt;\n&lt;b&gt;用户名&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">user_name</span><span class="si">}</span><span class="sb">\n&lt;b&gt;时间&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">date</span><span class="si">}</span><span class="sb">\n&lt;b&gt;内容&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">\n&lt;b&gt;文章名&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">article</span><span class="si">}</span><span class="sb">\n&lt;b&gt;文章链接&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">article_url</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Sending out&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span><span class="nx">chat_id</span><span class="o">:</span> <span class="nx">CHAT_ID</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">disable_notification</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">parse_mode</span><span class="o">:</span> <span class="s2">&#34;HTML&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Telegram API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="sb">`https://api.telegram.org/bot</span><span class="si">${</span><span class="nx">TG_API_TOKEN</span><span class="si">}</span><span class="sb">/sendMessage`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//POST
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">postData</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;We got&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Zapier output
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">output</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续向下，点击Test action可以进行测试，接收待审核评论的消息效果如图：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/disqus_telegram6.png" title="disqus_telegram6.png" data-thumbnail="/blog_images/disqus_telegram6.png">
        
    </a>
</div>
<h2 id="已审批通过的新评论" class="headerLink">
    <a href="#%e5%b7%b2%e5%ae%a1%e6%89%b9%e9%80%9a%e8%bf%87%e7%9a%84%e6%96%b0%e8%af%84%e8%ae%ba" class="header-mark"></a>已审批/通过的新评论</h2><p>创建一个新的Zap，设置步骤与待审批的新评论设置类似，仅在某些部分有一些更改：</p>
<ul>
<li>设置trigger时include改为选择Approved Posts；</li>
<li>Set up action中Input Data设置如下图，<code>admin_url</code>设置为Disqus用户主页的链接，如：<code>https://disqus.com/by/Ftbom/</code></li>
</ul>
<div style="text-align: center;"><a class="lightgallery" href="/blog_images/disqus_telegram7.png" title="disqus_telegram7.png" data-thumbnail="/blog_images/disqus_telegram7.png">
        
    </a></div>
<ul>
<li>Set up action的Code中填入的代码改为：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">TG_API_TOKEN</span> <span class="o">=</span> <span class="nx">inputData</span><span class="p">.</span><span class="nx">tg_token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">CHAT_ID</span> <span class="o">=</span> <span class="nx">inputData</span><span class="p">.</span><span class="nx">tg_chatid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">postData</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="sb">`&lt;b&gt;新评论&lt;/b&gt;\n&lt;b&gt;用户名&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">user_name</span><span class="si">}</span><span class="sb">\n&lt;b&gt;时间&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">date</span><span class="si">}</span><span class="sb">\n&lt;b&gt;内容&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">\n&lt;b&gt;文章名&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">article</span><span class="si">}</span><span class="sb">\n&lt;b&gt;文章链接&lt;/b&gt;：</span><span class="si">${</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">article_url</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span><span class="nx">chat_id</span><span class="o">:</span> <span class="nx">CHAT_ID</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">disable_notification</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">parse_mode</span><span class="o">:</span> <span class="s2">&#34;HTML&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="sb">`https://api.telegram.org/bot</span><span class="si">${</span><span class="nx">TG_API_TOKEN</span><span class="si">}</span><span class="sb">/sendMessage`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="p">{</span><span class="nx">info</span><span class="o">:</span> <span class="s1">&#39;do nothing&#39;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">isAnonymous</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resp</span> <span class="o">=</span> <span class="p">{</span><span class="nx">info</span><span class="o">:</span> <span class="s1">&#39;is anonymous&#39;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">inputData</span><span class="p">.</span><span class="nx">profileUrl</span> <span class="o">==</span> <span class="nx">inputData</span><span class="p">.</span><span class="nx">admin_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resp</span> <span class="o">=</span> <span class="p">{</span><span class="nx">info</span><span class="o">:</span> <span class="s1">&#39;is admin&#39;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Sending out&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resp</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">postData</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;We got&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">output</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="结语" class="headerLink">
    <a href="#%e7%bb%93%e8%af%ad" class="header-mark"></a>结语</h2><p>经过上述步骤的设置，对于所有待审批的评论都通知；对于已审批/通过的评论，若发帖人是匿名用户或博主则不进行通知。</p>
<p>当网站上出现新评论后，大概延迟2-10分钟才会收到通知。</p>
]]></description>
</item><item>
    <title>pyTelegramBotAPI基础</title>
    <link>https://ftbom.github.io/basic_of_pytelegrambotapi/</link>
    <pubDate>Wed, 04 Jan 2023 09:07:21 &#43;0800</pubDate><author>
        <name>Ftbom</name>
    </author><guid>https://ftbom.github.io/basic_of_pytelegrambotapi/</guid>
    <description><![CDATA[<div style="text-align: center;">
    
</div>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>pyTelegramBotAPI版本<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">pyTelegramBotAPI 4.8.0</div>
        </div>
    </div>
<p><a href="https://github.com/eternnoir/pyTelegramBotAPI" target="_blank" rel="noopener noreferrer">pyTelegramBotAPI</a>是用于开发Telegram机器人的Python库，使用简单，上手较快。在这里记录一下pyTelegramBotAPI库的基础用法。</p>
<h2 id="基本部分" class="headerLink">
    <a href="#%e5%9f%ba%e6%9c%ac%e9%83%a8%e5%88%86" class="header-mark"></a>基本部分</h2><p>Telegram机器人运行所需的最基本部分为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">telebot</span>
</span></span><span class="line"><span class="cl"><span class="n">bot</span> <span class="o">=</span> <span class="n">telebot</span><span class="o">.</span><span class="n">TeleBot</span><span class="p">(</span><span class="s2">&#34;YOUR_BOT_TOKEN&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">bot</span><span class="o">.</span><span class="n">infinity_polling</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>初始化<code>TeleBot</code>对象时需传入向<a href="https://t.me/BotFather" target="_blank" rel="noopener noreferrer">@BotFather</a>申请的token。</p>
<p>通过以下代码可以设置代理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">telebot</span> <span class="kn">import</span> <span class="n">apihelper</span>
</span></span><span class="line"><span class="cl"><span class="n">apihelper</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;http&#39;</span><span class="p">:</span> <span class="s1">&#39;http://127.0.0.1:108&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">:</span> <span class="s1">&#39;http://127.0.0.1:108&#39;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="绑定命令" class="headerLink">
    <a href="#%e7%bb%91%e5%ae%9a%e5%91%bd%e4%bb%a4" class="header-mark"></a>绑定命令</h2><p>以下代码定义了机器人的<code>/start</code>和<code>/help</code>命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">telebot</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span> <span class="o">=</span> <span class="n">telebot</span><span class="o">.</span><span class="n">TeleBot</span><span class="p">(</span><span class="s2">&#34;YOUR_BOT_TOKEN&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@bot</span><span class="o">.</span><span class="n">message_handler</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_welcome</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;Test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@bot</span><span class="o">.</span><span class="n">message_handler</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_help</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;&lt;b&gt;Test&lt;/b&gt;&#34;</span><span class="p">,</span> <span class="n">parse_mode</span> <span class="o">=</span> <span class="s2">&#34;HTML&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span><span class="o">.</span><span class="n">infinity_polling</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>send_message</code>函数传入的第一个参数是当前对话的id，第二个参数是发送消息的内容。通过<code>parse_mode</code>可以设置消息内容的格式。</p>
<p>上述代码的运行效果如下：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/pytelegrambotapi_1.png" title="pytelegrambotapi_1.png" data-thumbnail="/blog_images/pytelegrambotapi_1.png">
        
    </a>
</div>
<h2 id="编辑消息" class="headerLink">
    <a href="#%e7%bc%96%e8%be%91%e6%b6%88%e6%81%af" class="header-mark"></a>编辑消息</h2><p>编辑消息的函数为<code>edit_message_text</code>，使用实例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">bot</span><span class="o">.</span><span class="n">edit_message_text</span><span class="p">(</span><span class="s1">&#39;Edited&#39;</span><span class="p">,</span> <span class="n">chat_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">message_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>第一个参数是消息的内容，第二个参数是对话的id，第三个参数是消息的id。若消息的内容与编辑之前相同，则会报错。</p>
<h2 id="定义下一步" class="headerLink">
    <a href="#%e5%ae%9a%e4%b9%89%e4%b8%8b%e4%b8%80%e6%ad%a5" class="header-mark"></a>定义下一步</h2><p>通过<code>register_next_step_handler</code>函数可以定义下一步的操作的函数，同时可以向函数传递参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">telebot</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span> <span class="o">=</span> <span class="n">telebot</span><span class="o">.</span><span class="n">TeleBot</span><span class="p">(</span><span class="s2">&#34;YOUR_BOT_TOKEN&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_next</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">test1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test2</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">test1</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">test2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@bot</span><span class="o">.</span><span class="n">message_handler</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;Test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bot</span><span class="o">.</span><span class="n">register_next_step_handler</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">test_next</span><span class="p">,</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="s1">&#39;test2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span><span class="o">.</span><span class="n">infinity_polling</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下一步操作将会在接收到用户输入后进行触发。</p>
<p>上述代码的运行效果如下：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/pytelegrambotapi_2.png" title="pytelegrambotapi_2.png" data-thumbnail="/blog_images/pytelegrambotapi_2.png">
        
    </a>
</div>
<h2 id="消息按键" class="headerLink">
    <a href="#%e6%b6%88%e6%81%af%e6%8c%89%e9%94%ae" class="header-mark"></a>消息按键</h2><p>Telegram的消息按键有两种：<code>ReplyKeyboard</code>和<code>InlineKeyboard</code></p>
<h3 id="replykeyboard" class="headerLink">
    <a href="#replykeyboard" class="header-mark"></a>ReplyKeyboard</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">telebot</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">telebot.types</span> <span class="kn">import</span> <span class="n">ReplyKeyboardMarkup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span> <span class="o">=</span> <span class="n">telebot</span><span class="o">.</span><span class="n">TeleBot</span><span class="p">(</span><span class="s2">&#34;YOUR_BOT_TOKEN&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test_next</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">test1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test2</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">test1</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">test2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">ReplyKeyboardRemove</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@bot</span><span class="o">.</span><span class="n">message_handler</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">markup</span> <span class="o">=</span> <span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">resize_keyboard</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">markup</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="s1">&#39;test2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;Test&#34;</span><span class="p">,</span> <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">markup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bot</span><span class="o">.</span><span class="n">register_next_step_handler</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">test_next</span><span class="p">,</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="s1">&#39;test2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span><span class="o">.</span><span class="n">infinity_polling</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>ReplyKeyboardMarkup</code>初始化时将<code>resize_keyboard</code>设为<code>True</code>，则按键会自动调节到合适的高度。</p>
<p>当输入<code>/test</code>，机器人的运行结果为：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/pytelegrambotapi_3.png" title="pytelegrambotapi_3.png" data-thumbnail="/blog_images/pytelegrambotapi_3.png">
        
    </a>
</div>
<p>若将<code>reply_markup</code>的值设为<code>ReplyKeyboardRemove</code>，按键会在发送该消息后消失，否则按键不会消失。</p>
<p>运行效果为：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/pytelegrambotapi_4.png" title="pytelegrambotapi_4.png" data-thumbnail="/blog_images/pytelegrambotapi_4.png">
        
    </a>
</div>
<h3 id="inlinekeyboard" class="headerLink">
    <a href="#inlinekeyboard" class="header-mark"></a>InlineKeyboard</h3><p><code>InlineKeyboard</code>是在消息的下方带有按键，且可定义按键的类型，常用的按键类型为：</p>
<ul>
<li>callback_data：按下按键则调用回调函数</li>
<li>url：按下按键则打开链接</li>
</ul>
<p>pyTelegramBotAPI提供了<code>quick_markup</code>函数来帮助创建<code>InlineKeyboardMarkup</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">telebot</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">telebot.util</span> <span class="kn">import</span> <span class="n">quick_markup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span> <span class="o">=</span> <span class="n">telebot</span><span class="o">.</span><span class="n">TeleBot</span><span class="p">(</span><span class="s2">&#34;YOUR_BOT_TOKEN&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@bot</span><span class="o">.</span><span class="n">message_handler</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">button</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;test1&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;callback_data&#34;</span><span class="p">:</span> <span class="s2">&#34;test&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;test2&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;google.com&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">    <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;Test&#34;</span><span class="p">,</span> <span class="n">reply_markup</span> <span class="o">=</span> <span class="n">quick_markup</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="n">row_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@bot</span><span class="o">.</span><span class="n">callback_query_handler</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">call</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">call</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&#34;test&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;Test Callback&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">bot</span><span class="o">.</span><span class="n">answer_callback_query</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bot</span><span class="o">.</span><span class="n">infinity_polling</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>quick_markup</code>的<code>row_width</code>参数定义了同一行的最大按钮数量。</p>
<p>上述代码定义的<code>InlineKeyboard</code>样式为：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/pytelegrambotapi_5.png" title="pytelegrambotapi_5.png" data-thumbnail="/blog_images/pytelegrambotapi_5.png">
        
    </a>
</div>
<p>通过<code>@bot.callback_query_handler</code>函数修饰符对<code>callback_data</code>处理，<code>call.data</code>对应<code>callback_data</code>。再按下按键后，按键上会出现进度标志，通过调用<code>answer_callback_query</code>可以消去进度标志。</p>
<p>上述代码，按下test1按钮后，结果为：</p>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/pytelegrambotapi_6.png" title="pytelegrambotapi_6.png" data-thumbnail="/blog_images/pytelegrambotapi_6.png">
        
    </a>
</div>
<h2 id="文件处理" class="headerLink">
    <a href="#%e6%96%87%e4%bb%b6%e5%a4%84%e7%90%86" class="header-mark"></a>文件处理</h2><p>Telegram消息主要的文件类型为：<code>animation</code>、<code>audio</code>、<code>document</code>、<code>photo</code>、<code>sticker</code>、<code>video</code>、<code>video_note</code>、<code>voice</code>，这些文件类型都有对应的<code>file_id</code>，通过id可以获取文件的下载链接。</p>
<p>获取id:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">file_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">file_id</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>获取下载链接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">download_url</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_file_url</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>若收到的消息不是此种文件类型，则<code>message.&lt;type&gt;</code>返回<code>None</code></p>
<p>在这些文件类型中，<code>photo</code>类型有所不同，其返回值是一个数组，数组的每个元素对应不同的分辨率。</p>
<h2 id="结语" class="headerLink">
    <a href="#%e7%bb%93%e8%af%ad" class="header-mark"></a>结语</h2><p>这篇文章中记录的是pyTelegramBotAPI的基本用法，也是我在项目<a href="https://github.com/Ftbom/mypybot" target="_blank" rel="noopener noreferrer">mypybot</a>中用到的主要API内容。</p>
]]></description>
</item><item>
    <title>LANraragi插件小记</title>
    <link>https://ftbom.github.io/lanraragi_plugins/</link>
    <pubDate>Tue, 03 Jan 2023 16:20:52 &#43;0800</pubDate><author>
        <name>Ftbom</name>
    </author><guid>https://ftbom.github.io/lanraragi_plugins/</guid>
    <description><![CDATA[<div style="text-align: center;">
    
</div>
<p>LANraragi提供了丰富的插件和脚本，借助插件能够以多种途径获取漫画的信息，但是这些插件并没有完全满足我的需求。</p>
<p>于是有了这篇文章，记录我的LANraragi插件编写过程。</p>
<h2 id="需求" class="headerLink">
    <a href="#%e9%9c%80%e6%b1%82" class="header-mark"></a>需求</h2><p>在LANraragi中，漫画的信息被记录成<code>tags</code>和<code>categories</code>，即标签和种类。</p>
<p>我的需求是能从文件的目录结构提取出漫画的标签和种类，文件的结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">category1
</span></span><span class="line"><span class="cl">  --tag1
</span></span><span class="line"><span class="cl">      --mangafile1
</span></span><span class="line"><span class="cl">      --mangafile2
</span></span><span class="line"><span class="cl">  --tag2
</span></span><span class="line"><span class="cl">      --mangafile3
</span></span><span class="line"><span class="cl">category2
</span></span><span class="line"><span class="cl">  --tag3
</span></span><span class="line"><span class="cl">      --mangafile4
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="折腾结果" class="headerLink">
    <a href="#%e6%8a%98%e8%85%be%e7%bb%93%e6%9e%9c" class="header-mark"></a>折腾结果</h2><p>LANraragi中并不存在实现上述功能的插件，于是我就参照已有的插件，实现了这些功能。</p>
<p>最终完成了一个脚本和一个插件：</p>
<ul>
<li>TagFolder.pm(插件)</li>
</ul>
<blockquote>
<p>将文件所属的文件夹名作为漫画的tag</p>
</blockquote>
<ul>
<li>TopfolderCat.pm(脚本)</li>
</ul>
<blockquote>
<p>将文件所属的顶层文件夹名作为漫画的category</p>
</blockquote>
<h3 id="tagfolderpm" class="headerLink">
    <a href="#tagfolderpm" class="header-mark"></a>TagFolder.pm</h3><blockquote>
<p>参照Filename Parsing v.1.0 by Difegue</p>
</blockquote>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/tagfolder.png" title="tagfolder.png" data-thumbnail="/blog_images/tagfolder.png">
        
    </a>
</div>
<p>使用说明：</p>
<ul>
<li>Plugin Settings设置tag的类别，如图中所示则最终tag效果为<code>artist: tagname</code></li>
<li>开启Run Automatically则自动对新添加的漫画运行插件</li>
</ul>
<p>文件内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">LANraragi::Plugin::Metadata::TagFolder</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Plugins can freely use all Perl packages already installed on the system</span>
</span></span><span class="line"><span class="cl"><span class="c1">#Try however to restrain yourself to the ones already installed for LRR (see tools/cpanfile) to avoid extra installations by the end-user.</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">File::Basename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#You can also use the LRR Internal API when fitting.</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Model::Plugins</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Database</span> <span class="sx">qw(redis_encode redis_decode)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Logging</span> <span class="sx">qw(get_logger)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Meta-information about your plugin.</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">plugin_info</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#Standard metadata</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>      <span class="o">=&gt;</span> <span class="s">&#34;Use foldername as tag&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">type</span>      <span class="o">=&gt;</span> <span class="s">&#34;metadata&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">namespace</span> <span class="o">=&gt;</span> <span class="s">&#34;tagfolder&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">author</span>    <span class="o">=&gt;</span> <span class="s">&#34;Ftbom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span>   <span class="o">=&gt;</span> <span class="s">&#34;1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;Generate the tag from the folder&#39;s name.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">icon</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAL1JREFUOI1jZMABpNbH/sclx8DAwPAscDEjNnEMQUIGETIYhUOqYdgMhTPINQzdUEZqGIZsKBM1DEIGTOiuexqwCKdidDl0vtT62P9kuZCJEWuKYWBgYGBgRHbh04BFDNIb4jAUbbSrZTARUkURg6lD10OUC/0PNaMYgs1Skgwk1jCSDCQWoBg46dYmhite0+D8pwGLCMY6uotRDOy8toZBkI2HIhcO/pxCm8KBUkOxFl/kGoq3gCXFYFxVAACeoU/8xSNybwAAAABJRU5ErkJggg==&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">parameters</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=&gt;</span> <span class="s">&#34;The category of tag&#34;</span> <span class="p">}</span> <span class="p">]</span> <span class="c1">#plugin设置</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Mandatory function to be implemented by your plugin</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">get_tags</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">shift</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$lrr_info</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>    <span class="c1"># Global info hash</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="p">(</span><span class="nv">$category</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>    <span class="c1"># Plugin parameters</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span> <span class="s">&#34;tagfolder&#34;</span><span class="p">,</span> <span class="s">&#34;plugins&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$file</span>   <span class="o">=</span> <span class="nv">$lrr_info</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">file_path</span><span class="p">};</span> <span class="c1">#完整文件地址</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$tagstring</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># lrr_info&#39;s file_path is taken straight from the filesystem, which might not be proper UTF-8.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Run a decode to make sure we can derive tags with the proper encoding.</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file</span> <span class="o">=</span> <span class="n">redis_decode</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get the filename from the file_path info field</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="p">(</span> <span class="nv">$filename</span><span class="p">,</span> <span class="nv">$filepath</span><span class="p">,</span> <span class="nv">$suffix</span> <span class="p">)</span> <span class="o">=</span> <span class="n">fileparse</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="sx">qr/\.[^.]*/</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$_</span> <span class="o">=</span> <span class="s">&#34;$filepath&#34;</span><span class="p">;</span> <span class="c1">#获取文件地址</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="sr">/\/([^\/]+)\/$/</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$tagstring</span><span class="o">=</span><span class="s">&#34;$category:$1&#34;</span><span class="p">;</span> <span class="c1">#上级目录作tag名</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#34;Sending the following tags to LRR: &#34;</span> <span class="o">.</span> <span class="nv">$tagstring</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span> <span class="n">tags</span> <span class="o">=&gt;</span> <span class="nv">$tagstring</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="topfoldercatpm" class="headerLink">
    <a href="#topfoldercatpm" class="header-mark"></a>TopfolderCat.pm</h3><blockquote>
<p>参照Subfolders to Categories v.1.0 by Difegue</p>
</blockquote>
<div style="text-align: center;">
<a class="lightgallery" href="/blog_images/TopfolderCat.png" title="TopfolderCat.png" data-thumbnail="/blog_images/TopfolderCat.png">
        
    </a>
</div>
<p>使用说明：</p>
<ul>
<li>点击Trigger Script运行脚本</li>
<li>Plugin Settings设置是否先删除已有的类型</li>
</ul>
<p>文件内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">LANraragi::Plugin::Scripts::TopfolderCat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">File::Find</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">File::Basename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">Data::Dumper</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Logging</span> <span class="sx">qw(get_logger)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Generic</span> <span class="sx">qw(is_archive)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Utils::Database</span> <span class="sx">qw(compute_id)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">LANraragi::Model::Category</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">our</span> <span class="nv">$fatherdirname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Meta-information about your plugin.</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">plugin_info</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#Standard metadata</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>      <span class="o">=&gt;</span> <span class="s">&#34;Top Subfolders to Categories&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">type</span>      <span class="o">=&gt;</span> <span class="s">&#34;script&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">namespace</span> <span class="o">=&gt;</span> <span class="s">&#34;Tfldr2cat&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">author</span>    <span class="o">=&gt;</span> <span class="s">&#34;Ftbom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span>   <span class="o">=&gt;</span> <span class="s">&#34;1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">icon</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAuJJREFUOI3FlE1sVFUUx3/nvVdaSqd0sAmElDYopOWjsKiEnYkLowU2uMGw0ajBhS5oqAtwo3FTaIQNCz7CBldEE01M+AglJMACUyBQrI6iQ2groNNxpjPz5n3MnXddvOnrfACNK09yk/fuved3//933j3wf8Thw6O6q6tHd3X16FOnTusX7ZW7I7H0kuUrV6hCtmHxt7UnOXHiDInEJAAzM49kscMtw2xesWHfKOTGASNa+GnmHfYP7gSgr28TY2PnF4UBWAD88Tlk7kFVyuDbX0ew43vzU/6bnc+12vnqx4OrX//i4gIQXS2uJkZGvqRXD3Q/V9LKXdjmSxcmjq7ahi6vtRazMKAHGua8oolbsHDyFk7iF4r/3IOyGl9QKI1u+vo2kUhMsmZ3T8Pa5c+E5vYYzbFWWkQTW23R+XKc+9/+eKUB+MbBHZWqhpW9MGSjtdDes57OzRtZ2hFD4tshcEAVkHIeVIapse8wDPNQxbKBDuDhxHKODd5myZ44698dBTQgUbEkex0CFzJXIfDC58CDwCP3Z1ZtPpAaD4FWnJIv2Nkm+j85AroE/jRoHwI/SgoBbt27h+54DS3je0VEh7VtimOnm2mKxRcguhpUDXvGUDb9bd3fh14rCtNPWuh9/6s6RfWq6mEetG0le/cb5KPbpajKActwChaIVNR5ddAqeLkCmt9TLjCbzEVFtQDstENTW0c4M58cJbiNsPmxtBs7eQ03p87VANP3J+n94CjiPKj76N4z7M4f6IPKk35YAFMORUCzpRU3/VdoV82BytUm+jMQlEArlBJmEyncORdnroTypxCRt7YMp5IRUBVzv/cPnV0n+VshyH8MgYuycyjHJjPt4GbyONki5VIAItfQnBeTG62YD1458DTF8EJXscSw1lEu4s0m8TJ/k/o5iZuZIygHlb+ZHwzkUoC+2T+cuiNSd08/re1qMjFa25YM5D0xjVtGe8fUhg9/zfMf41+ZdKPYI8TqHgAAAABJRU5ErkJggg==&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;Scan your Content Folder and automatically create Static Categories for each top subfolder.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">parameters</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">[</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&#34;bool&#34;</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=&gt;</span> <span class="s">&#34;Delete all your static categories before creating the ones matching your subfolders&#34;</span> <span class="p">}</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Mandatory function to be implemented by your script</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">run_script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">shift</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$lrr_info</span>          <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="p">(</span><span class="nv">$delete_old_cats</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$logger</span>            <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span> <span class="s">&#34;Folder2Category&#34;</span><span class="p">,</span> <span class="s">&#34;plugins&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$userdir</span>           <span class="o">=</span> <span class="nn">LANraragi::Model::Config</span><span class="o">-&gt;</span><span class="n">get_userdir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">%subfolders</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">@created_categories</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$delete_old_cats</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">&#34;Deleting all Static Categories before folder walking as instructed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">@categories</span> <span class="o">=</span> <span class="nn">LANraragi::Model::Category</span><span class="o">-&gt;</span><span class="n">get_category_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">my</span> <span class="nv">$category</span> <span class="p">(</span><span class="nv">@categories</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$category</span><span class="p">}{</span><span class="s">&#34;search&#34;</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&#34;&#34;</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">my</span> <span class="nv">$cat_id</span> <span class="o">=</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$category</span><span class="p">}{</span><span class="s">&#34;id&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">(</span><span class="s">&#34;Deleting &#39;$cat_id&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nn">LANraragi::Model::Category::</span><span class="n">delete_category</span><span class="p">(</span><span class="nv">$cat_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Walk through content folder and find all subfolders with files in them</span>
</span></span><span class="line"><span class="cl">    <span class="n">find</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   <span class="n">wanted</span> <span class="o">=&gt;</span> <span class="k">sub</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">if</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span> <span class="ow">eq</span> <span class="nv">$userdir</span><span class="p">;</span>    <span class="c1"># Direct children of the content dir are excluded</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span> <span class="n">is_archive</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">unless</span> <span class="p">(</span> <span class="nb">exists</span><span class="p">(</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>        <span class="c1"># Create array in hash for this folder</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">},</span> <span class="nv">$_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$fatherdirname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">no_chdir</span>    <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">follow_fast</span> <span class="o">=&gt;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$userdir</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$logger</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#34;Find routine results: &#34;</span> <span class="o">.</span> <span class="n">Dumper</span> <span class="nv">%subfolders</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># For each subfolder with file, create a category bearing its name and containing all its files</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="k">my</span> <span class="nv">$folder</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%subfolders</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$catID</span> <span class="o">=</span> <span class="nn">LANraragi::Model::Category::</span><span class="n">create_category</span><span class="p">(</span> <span class="nv">$folder</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">push</span> <span class="nv">@created_categories</span><span class="p">,</span> <span class="nv">$catID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">my</span> <span class="nv">$file</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$folder</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="n">compute_id</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="o">||</span> <span class="k">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nn">LANraragi::Model::Category::</span><span class="n">add_to_category</span><span class="p">(</span> <span class="nv">$catID</span><span class="p">,</span> <span class="nv">$id</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#顶级目录名作分类名</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span> <span class="n">created_categories</span> <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@created_categories</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="代码浅析" class="headerLink">
    <a href="#%e4%bb%a3%e7%a0%81%e6%b5%85%e6%9e%90" class="header-mark"></a>代码浅析</h2><p>简单分析一下这两个插件的代码，我并没有系统地学习过Perl语言，分析过程可能存在错误。</p>
<p><code>plugin_info</code>函数返回插件的基本信息；TagFolder是元数据插件，主体内容是<code>get_tags</code>函数；TopfolderCat是脚本，主体内容是<code>run_script</code>函数。</p>
<p><code>plugin_info</code>函数的parameters返回值定义了插件的设置项，例如：
TagFolder定义插件的设置项是string类型，获取输入字符；TopfolderCat定义插件的设置项是bool类型，获取开关的状态。</p>
<p>在主体函数中可以通过<code>@_</code>获取插件的设置值。</p>
<h3 id="tagfolderpm分析" class="headerLink">
    <a href="#tagfolderpm%e5%88%86%e6%9e%90" class="header-mark"></a>TagFolder.pm分析</h3><p>TagFolder参照Filename Parsing，对其中关键代码的运行过程进行分析。</p>
<p>首先获取全局信息和插件设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$lrr_info</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="c1">#全局信息</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="p">(</span><span class="nv">$category</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span> <span class="c1">#插件设置</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>全局信息中包括文件路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$file</span>   <span class="o">=</span> <span class="nv">$lrr_info</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">file_path</span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后从文件路径中分离出文件名和文件所在文件夹路径，我们需要的是文件夹路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="p">(</span> <span class="nv">$filename</span><span class="p">,</span> <span class="nv">$filepath</span><span class="p">,</span> <span class="nv">$suffix</span> <span class="p">)</span> <span class="o">=</span> <span class="n">fileparse</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="sx">qr/\.[^.]*/</span> <span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从文件夹路径中获取文件夹名，得到tag字符串：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="nv">$_</span> <span class="o">=</span> <span class="s">&#34;$filepath&#34;</span><span class="p">;</span> <span class="c1">#$_是默认的参数变量</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="sr">/\/([^\/]+)\/$/</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$tagstring</span><span class="o">=</span><span class="s">&#34;$category:$1&#34;</span><span class="p">;</span> <span class="c1">#$1获取正则表达式匹配的第一项</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后输出tag信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">return</span> <span class="p">(</span> <span class="n">tags</span> <span class="o">=&gt;</span> <span class="nv">$tagstring</span> <span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="topfoldercatpm分析" class="headerLink">
    <a href="#topfoldercatpm%e5%88%86%e6%9e%90" class="header-mark"></a>TopfolderCat.pm分析</h3><p>TopfolderCat.pm参照Subfolders to Categories，相较于参考文件改动较小，改动部分为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">return</span> <span class="k">if</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span> <span class="ow">eq</span> <span class="nv">$userdir</span><span class="p">;</span>    <span class="c1"># Direct children of the content dir are excluded</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="n">is_archive</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">unless</span> <span class="p">(</span> <span class="nb">exists</span><span class="p">(</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>        <span class="c1"># Create array in hash for this folder</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">},</span> <span class="nv">$_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$fatherdirname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里假设文件目录结构为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">category1
</span></span><span class="line"><span class="cl">  --tag1
</span></span><span class="line"><span class="cl">      --mangafile1
</span></span><span class="line"><span class="cl">      --mangafile2
</span></span><span class="line"><span class="cl">  --tag2
</span></span><span class="line"><span class="cl">      --mangafile3
</span></span><span class="line"><span class="cl">category2
</span></span><span class="line"><span class="cl">  --tag3
</span></span><span class="line"><span class="cl">      --mangafile4
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先排除漫画目录的直接子文件夹，即categroy1、categroy2等文件夹：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">return</span> <span class="k">if</span> <span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span> <span class="ow">eq</span> <span class="nv">$userdir</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于其他的文件和文件夹，如果是文件夹，即tag1、tag2等文件夹，则将其父目录的名称赋值给<code>fatherdirname</code>。即将categroy1、categroy2等赋值给<code>fatherdirname</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$fatherdirname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="nv">$</span><span class="nn">File::Find::</span><span class="nv">dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果是文件，若其路径中存在<code>fatherdirname</code>，则将其添加到对应数组。例如：mangafile1、mangafile2、mangafile3文件被添加到category1对应的数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="n">is_archive</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">unless</span> <span class="p">(</span> <span class="nb">exists</span><span class="p">(</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>        <span class="c1"># Create array in hash for this folder</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">push</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$fatherdirname</span><span class="p">}</span> <span class="p">},</span> <span class="nv">$_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后通过这些数组来创建类别，并将对应漫画添加到类别中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">for</span> <span class="k">my</span> <span class="nv">$folder</span> <span class="p">(</span> <span class="nb">keys</span> <span class="nv">%subfolders</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$catID</span> <span class="o">=</span> <span class="nn">LANraragi::Model::Category::</span><span class="n">create_category</span><span class="p">(</span> <span class="nv">$folder</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">push</span> <span class="nv">@created_categories</span><span class="p">,</span> <span class="nv">$catID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">my</span> <span class="nv">$file</span> <span class="p">(</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$subfolders</span><span class="p">{</span><span class="nv">$folder</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">my</span> <span class="nv">$id</span> <span class="o">=</span> <span class="n">compute_id</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="o">||</span> <span class="k">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nn">LANraragi::Model::Category::</span><span class="n">add_to_category</span><span class="p">(</span> <span class="nv">$catID</span><span class="p">,</span> <span class="nv">$id</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description>
</item><item>
    <title>在Termux中安装LANraragi</title>
    <link>https://ftbom.github.io/lanraragi_in_termux/</link>
    <pubDate>Tue, 03 Jan 2023 12:41:00 &#43;0800</pubDate><author>
        <name>Ftbom</name>
    </author><guid>https://ftbom.github.io/lanraragi_in_termux/</guid>
    <description><![CDATA[<div style="text-align: center;">
    
</div>
<p><a href="https://github.com/Difegue/LANraragi" target="_blank" rel="noopener noreferrer">LANraragi</a>是开源的漫画管理服务器，开发者提供了多种安装方式供选择。本文介绍如何在Termux中安装LANraragi，实现对Android手机内的漫画进行管理。</p>
<h2 id="安装termux及ubuntu发行版" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85termux%e5%8f%8aubuntu%e5%8f%91%e8%a1%8c%e7%89%88" class="header-mark"></a>安装Termux及Ubuntu发行版</h2><p><a href="https://termux.dev" target="_blank" rel="noopener noreferrer">Termux</a>是Android系统上的一个高级终端模拟器，可以运行很多Linux系统的软件，还可通过proot安装各种Linux系统发行版。推荐通过Github安装Termux软件。</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">第一次打开Termux若初始化失败，请使用代理</div>
        </div>
    </div>
<p>安装完成后，首先使Termux获取储存权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">termux-setup-storage
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装proot-distro：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pkg install proot-distro
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后安装Ubuntu</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">proot-distro install ubuntu
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装完成后，通过如下命令可进入Ubuntu</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proot-distro login ubuntu
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装lanraragi" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85lanraragi" class="header-mark"></a>安装LANraragi</h2><p>采用源码安装的方式安装LANraragi。</p>
<p>首先，进入Ubuntu并更新软件源：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proot-distro login ubuntu
</span></span><span class="line"><span class="cl">apt update
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先安装LANraragi所需的依赖项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install git curl build-essential make gnupg pkg-config cpanminus redis-server libarchive-dev imagemagick webp libssl-dev zlib1g-dev perlmagick ghostscript
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后安装npm和nodejs：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -sL install-node.vercel.app/lts <span class="p">|</span> bash
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装redis：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install redis
</span></span></code></pre></td></tr></table>
</div>
</div><p>克隆Git仓库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone -b master http://github.com/Difegue/LANraragi /home/koyomi/lanraragi
</span></span></code></pre></td></tr></table>
</div>
</div><p>打开目录并进行编译安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /home/koyomi/lanraragi <span class="o">&amp;&amp;</span> npm run lanraragi-installer install-full
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译需要30-60分钟。</p>
<p>若需要对LANraragi进行更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone -b master http://github.com/Difegue/LANraragi lanraragi
</span></span><span class="line"><span class="cl">cp -fr lanraragi /home/koyomi/
</span></span><span class="line"><span class="cl">npm run lanraragi-installer install-full
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="运行lanraragi" class="headerLink">
    <a href="#%e8%bf%90%e8%a1%8clanraragi" class="header-mark"></a>运行LANraragi</h2><p>通过以下命令运行LANraragi：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">redis-server /etc/redis/redis.conf
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/koyomi/lanraragi <span class="o">&amp;&amp;</span> npm start
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="设置档案位置" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%ae%e6%a1%a3%e6%a1%88%e4%bd%8d%e7%bd%ae" class="header-mark"></a>设置档案位置</h2><p>若已通过以下命令使Termux获取储存权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">termux-setup-storage
</span></span></code></pre></td></tr></table>
</div>
</div><p>则在Ubuntu的<code>/sdcard</code>目录下可以看到Android系统的文件，在LANraragi的设置中设置成对应的漫画目录即可。</p>
]]></description>
</item><item>
    <title>Julia脚本文件中使用Plots绘图</title>
    <link>https://ftbom.github.io/julia_plot_in_file/</link>
    <pubDate>Fri, 25 Feb 2022 20:33:38 &#43;0800</pubDate><author>
        <name>Ftbom</name>
    </author><guid>https://ftbom.github.io/julia_plot_in_file/</guid>
    <description><![CDATA[<div style="text-align: center;">
    
</div>
<p>Julia是一种高级通用动态编程语言，可以用于数值分析和科学计算等。</p>
<p>Julia语言没有内建的作图能力，作图需要通过安装扩展包来实现，常用的作图包有Gadfly、Plots和PyPlot。</p>
<p>本文介绍如何在Julia脚本文件中使用Plots进行绘图并正常显示绘图结果。</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>Julia和Plots版本<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Julia v1.7.2</p>
<p>Plots v1.25.11</p>
</div>
        </div>
    </div>
<h2 id="在repl中运行脚本文件" class="headerLink">
    <a href="#%e5%9c%a8repl%e4%b8%ad%e8%bf%90%e8%a1%8c%e8%84%9a%e6%9c%ac%e6%96%87%e4%bb%b6" class="header-mark"></a>在REPL中运行脚本文件</h2><p>在REPL中，Julia会对每个变量自动调用<code>display</code>函数进行显示。在REPL中直接使用<code>plot</code>函数可以正常显示绘图的结果。</p>
<p>本文的主要目的是使用脚本文件进行绘图，在REPL中运行脚本文件的命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="n">include</span><span class="p">(</span><span class="s">&#34;path/to/script.jl&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="使用julia-pathtoscriptjl运行脚本文件" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8julia-pathtoscriptjl%e8%bf%90%e8%a1%8c%e8%84%9a%e6%9c%ac%e6%96%87%e4%bb%b6" class="header-mark"></a>使用<code>julia path/to/script.jl</code>运行脚本文件</h2><p>如果不在REPL中运行脚本文件时，Julia不会自动调用<code>display</code>函数。</p>
<p>为了显示绘图结果，需要<a href="https://docs.juliaplots.org/latest/tutorial/#Plotting-in-Scripts" target="_blank" rel="noopener noreferrer">在代码中调用<code>display</code>函数</a>。</p>
<p>但是，使用<code>julia path/to/script.jl</code>运行脚本文件时，程序会在文件中所有语句执行完毕后自动退出，这样就看不到绘图结果。</p>
<p>为了防止Julia执行完所有语句后退出，可以在脚本文件的末尾使用<code>readline</code>函数。</p>
<p>这种运行方式下需将代码做如下更改：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>改为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">readline</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后终端运行<code>julia path/to/script.jl</code>即可得到绘图结果。</p>
<h2 id="使用vscode插件julia运行脚本文件" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8vscode%e6%8f%92%e4%bb%b6julia%e8%bf%90%e8%a1%8c%e8%84%9a%e6%9c%ac%e6%96%87%e4%bb%b6" class="header-mark"></a>使用VScode插件Julia运行脚本文件</h2><p>使用Julia插件运行代码时，会自动将绘图结果显示在一个新的标签栏中，于是直接使用<code>plot</code>函数就可以得到绘图结果。</p>
<p>需要注意的是：<strong>在VScode中不可使用Code Runner插件来运行脚本文件，而要使用Julia插件来运行脚本文件</strong>。</p>
]]></description>
</item></channel>
</rss>
